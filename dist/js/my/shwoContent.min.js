/*BBS_Demo_Github-0.0.1.js 2017-10-16 10:50 */
$(function(){function a(a,b,c){return a.substr(0,b-1)+c+a.substring(b,a.length)}$.ajax({url:"http://bbs-demo/src/php/show_content.php",type:"POST",success:function(b,c,d){var e=$.parseJSON(b),f="";$.each(e,function(a,b){f+="<h4>"+b.user+" 发表于 "+b.date+"</h4><h3>"+b.title+'</h3><div class="editor">'+b.content+'</div><div class="bottom"><span class="comment" data-id="'+b.id+'">'+b.count+'条评论</span><span class="up">收起</span></div><hr noshade="noshade" size="1" /><div class="comment_list"></div>'}),$(".content").append(f);var g=[],h=[];$.each($(".editor"),function(b,c){g[b]=$(c).html(),h[b]=g[b].substr(0,200),"<"==h[b].substring(199,200)&&(h[b]=a(h[b],200,"")),"</"==h[b].substring(198,200)&&(h[b]=a(h[b],200,""),h[b]=a(h[b],199,"")),g[b].length>200&&(h[b]+='...<span class="down">显示全部</span>',$(c).html(h[b])),$(".bottom .up").hide()}),$.each($(".editor"),function(a,b){$(this).on("click",".down",function(){$(".editor").eq(a).html(g[a]),$(this).hide(),$(".bottom .up").eq(a).show()})}),$.each($(".bottom"),function(a,b){$(this).on("click",".up",function(){$(".editor").eq(a).html(h[a]),$(this).hide(),$(".editor .down").eq(a).show()})}),$.each($(".bottom"),function(a,b){$(this).on("click",".comment",function(){var b=this,c=$(".comment_list").eq(a);$.cookie("user")?(c.has("form").length||$.ajax({url:"http://bbs-demo/src/php/show_comment.php",type:"POST",data:{titleid:$(b).attr("data-id")},beforeSend:function(a,b){c.append('<dl class="comment_load"><dd>正在加载评论</dd></dl>')},success:function(a,d){c.find(".comment_load").hide();var e=$.parseJSON(a),f=0;$.each(e,function(a,b){f=b.count,c.append('<dl class="comment_content"><dt>'+b.user+"</dt><dd>"+b.comment+'</dd><dd class="date">'+b.date+"</dd></dl>")}),c.append('<dl><dd><span class="load_more">加载更多评论</span></dd></dl>');var g=2;g>f&&(c.find(".load_more").off("click"),c.find(".load_more").hide()),c.find(".load_more").button().on("click",function(){c.find(".load_more").button("disable"),$.ajax({url:"http://bbs-demo/src/php/show_comment.php",type:"POST",data:{titleid:$(b).attr("data-id"),page:g},beforeSend:function(a,b){c.find(".load_more").html('<img src="img/more_load.gif" />')},success:function(a,b){var d=$.parseJSON(a);$.each(d,function(a,b){c.find(".comment_content").last().after('<dl class="comment_content"><dt>'+b.user+"</dt><dd>"+b.comment+'</dd><dd class="date">'+b.date+"</dd></dl>")}),c.find(".load_more").button("enable"),c.find(".load_more").html("加载更多评论"),g++,g>f&&(c.find(".load_more").off("click"),c.find(".load_more").hide())}})}),c.append('<form><dl class="comment_add"><dt><textarea name="comment"></textarea></dt><dd><input type="hidden" name="titleid" value="'+$(b).attr("data-id")+'" /><input type="hidden" name="user" value="'+$.cookie("user")+'" /><input type="button" value="发表" /></dd></dl></form>'),c.find("input[type=button]").button().click(function(){var a=this;c.find("form").ajaxSubmit({url:"http://bbs-demo/src/php/add_comment.php",type:"POST",beforeSubmit:function(b,c,d){$(a).popover({html:!0,content:'正在发表评论&nbsp;<img src="img/loading.gif"/>',placement:"top",delay:{show:50,hide:50},trigger:"manual"}),$(a).popover("show"),$(a).attr("disabled","")},success:function(b,d){$(a).popover({html:!0,content:'评论提交成功&nbsp;<img src="img/success.gif"/>',placement:"top",delay:{show:50,hide:50},trigger:"manual"}),b&&setTimeout(function(){$(a).removeAttr("disabled","");var b=new Date;$(a).popover("hide"),c.prepend('<dl class="comment_content"><dt>'+$.cookie("user")+"</dt><dd>"+c.find("textarea").val()+"</dd><dd>"+b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()+" "+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()+"</dd></dl>"),c.find("form").resetForm()},1e3)}})})}}),c.is(":hidden")?c.show():c.hide()):($(".comment").eq(a).popover({html:!0,content:'您还未登录！&nbsp;<img src="img/error.png"/>',placement:"right",delay:{show:50,hide:50},trigger:"manual"}),$(".comment").eq(a).popover("show"),setTimeout(function(){$(".comment").eq(a).popover("hide"),$("#logBox").modal({show:!0,keyboard:!0})},1e3))})})}})});