/*BBS_Demo_Github-0.0.1.js 2017-10-16 10:50 */
$(function(){function a(a){var c="";return c=a.substr(0,200),"</"==c.substring(198,200)&&(c=b(c,198,""),c=b(c,199,"")),"<"==c.substring(199,200)&&(c=b(c,199,"")),c+='...<span class="showAllContent"><strong>显示全部</strong></span>'}function b(a,b,c){return a.substr(0,b-1)+c+a.substring(b,a.length)}var c="bbs-github:80",d=$.ajax({url:"http://"+c+"/src/ajax/content.json",type:"GET",dataType:"json"}),e=function(a,b){var d=$.Deferred();return $.ajax({url:"http://"+c+"/src/php/show_comment.php",type:"POST",dataType:"json",jsonp:!1,data:{titleid:$(a).attr("data-id")},beforeSend:function(a,c){b.append('<dl class="comment_load"><dd>正在加载评论</dd></dl>')}}).done(function(a,b,c){d.resolve(a)}),d.promise()},f=function(a,b,d){var e=$.Deferred();return $.ajax({url:"http://"+c+"/src/php/show_comment.php",type:"POST",dataType:"json",jsonp:!1,data:{titleid:$(a).attr("data-id"),page:b},beforeSend:function(a,b){d.find(".load_more").html('<img src="img/more_load.gif" />')}}).done(function(a){e.resolve(a)}),e.promise()},g=function(a,b){var d=$.Deferred();return $.ajax({url:"http://"+c+"/src/php/add_comment.php",type:"POST",data:b,beforeSend:function(){$(a).popover({html:!0,content:'正在发表评论&nbsp;<img src="img/loading.gif"/>',placement:"top",delay:{show:50,hide:50},trigger:"manual"}),$(a).popover("show"),$(a).attr("disabled","")}}).done(function(a){d.resolve(a)}),d.promise()},h=function(b){var c="";$.each(b,function(b,d){c+="<h4><strong>"+d.user+"</strong> 发表于 <strong>"+d.date+"</strong></h4><h3>"+d.title+'</h3><div class="quesContent">'+a(d.content)+'</div><div class="quesFooter"><span class="showComment" data-id="'+d.id+'">'+d.count+'条评论</span><span class="hideContent"><strong>收起内容</strong></span></div><hr noshade="noshade" size="3"><div class="commentList"></div>'});var d=$(".myQues").detach();d.html(c),$(".container").append(d),$(".hideContent").hide(),i(b),j(b),k()},i=function(a){$.each($(".quesContent"),function(b,c){$(this).on("click",".showAllContent",function(){var c=$(".quesContent").eq(b).detach();c.html(a[b].content),$(".quesFooter").eq(b).before(c),$(".hideContent").eq(b).show()})})},j=function(b){$.each($(".quesFooter"),function(c,d){var e=$(this);e.on("click",".hideContent",function(){var d=$(".quesContent").eq(c).detach(),f=a(b[c].content);d.html(f),e.before(d),$(".hideContent").eq(c).hide()})})},k=function(){$.each($(".quesFooter"),function(a,b){var c=$(this);c.on("click",".showComment",function(){var b=this,c=$(".commentList").eq(a);c.is(":hidden")?c.show():c.hide(),$.cookie("user")?c.has("form").length||e(b,c).done(function(a){c.find(".comment_load").hide();var d=0;$.each(a,function(a,b){d=b.count,c.append('<dl class="comment_content"><dt>'+b.user+"</dt><dd>"+b.comment+'</dd><dd class="date">'+b.date+"</dd></dl>")}),c.append('<dl><dd><span class="load_more">加载更多评论</span></dd></dl>');var e=2;e>d&&(c.find(".load_more").off("click"),c.find(".load_more").hide()),c.find(".load_more").button().on("click",function(){c.find(".load_more").button("disable"),f(b,e,c).done(function(a){$.each(a,function(a,b){c.find(".comment_content").last().after('<dl class="comment_content"><dt>'+b.user+"</dt><dd>"+b.comment+'</dd><dd class="date">'+b.date+"</dd></dl>")}),c.find(".load_more").button("enable"),c.find(".load_more").html("加载更多评论"),e++,e>d&&(c.find(".load_more").off("click"),c.find(".load_more").hide())})}),c.append('<form><dl class="comment_add"><dt><textarea name="comment"></textarea></dt><dd><input type="hidden" name="titleid" value="'+$(b).attr("data-id")+'" /><input type="hidden" name="user" value="'+$.cookie("user")+'" /><input type="button" value="发表" /></dd></dl></form>'),c.find("input[type=button]").button().click(function(){var a=this,b=c.find("form").serialize();console.log(b),g(a,b).done(function(){$(a).popover({html:!0,content:'评论提交成功&nbsp;<img src="img/success.gif"/>',placement:"top",delay:{show:50,hide:50},trigger:"manual"}),setTimeout(function(){$(a).removeAttr("disabled","");var b=new Date;$(a).popover("hide"),c.prepend('<dl class="comment_content"><dt>'+$.cookie("user")+"</dt><dd>"+c.find("textarea").val()+"</dd><dd>"+b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()+" "+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()+"</dd></dl>"),c.find("form").resetForm()},1e3)})})}):($(".showComment").eq(a).popover({html:!0,content:'您还未登录！&nbsp;<img src="img/error.png"/>',placement:"right",delay:{show:50,hide:50},trigger:"manual"}),$(".showComment").eq(a).popover("show"),setTimeout(function(){$(".showComment").eq(a).popover("hide"),$("#logBox").modal({show:!0,keyboard:!0})},1e3))})})};d.done(h)});